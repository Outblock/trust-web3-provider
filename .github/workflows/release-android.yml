name: Release Android Package

on:
  release:
    types: [published]

jobs:
  release-android:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Cache Gradle packages
      uses: actions/cache@v3
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew
      working-directory: android

    - name: Extract version from tag
      id: version
      run: |
        TAG_NAME=${{ github.event.release.tag_name }}
        VERSION=${TAG_NAME#v}  # Remove 'v' prefix if present
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Extracted version: $VERSION"

    - name: Build Release AAR
      run: ./gradlew :lib:assembleRelease
      working-directory: android
      env:
        TAG_NAME: ${{ steps.version.outputs.version }}

    - name: Build Javadoc and Sources
      run: ./gradlew :lib:javaDocReleaseJar :lib:sourceReleaseJar
      working-directory: android
      env:
        TAG_NAME: ${{ steps.version.outputs.version }}

    - name: Publish to GitHub Packages
      run: ./gradlew :lib:publishReleasePublicationToGitHubPackagesRepository
      working-directory: android
      env:
        GPR_USER: ${{ github.actor }}
        GPR_API_KEY: ${{ secrets.GITHUB_TOKEN }}
        TAG_NAME: ${{ steps.version.outputs.version }}

    - name: Upload AAR to Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: android/lib/build/outputs/aar/web3-provider-release.aar
        asset_name: web3-provider-${{ steps.version.outputs.version }}.aar
        asset_content_type: application/octet-stream

    - name: Upload Sources JAR to Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: android/lib/build/libs/web3-provider-${{ steps.version.outputs.version }}-sources.jar
        asset_name: web3-provider-${{ steps.version.outputs.version }}-sources.jar
        asset_content_type: application/java-archive

    - name: Upload Javadoc JAR to Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ github.event.release.upload_url }}
        asset_path: android/lib/build/libs/web3-provider-${{ steps.version.outputs.version }}-javadoc.jar
        asset_name: web3-provider-${{ steps.version.outputs.version }}-javadoc.jar
        asset_content_type: application/java-archive

    - name: Create Release Summary
      run: |
        echo "## ðŸš€ Android Package Released Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Package Details" >> $GITHUB_STEP_SUMMARY
        echo "- **Group ID**: io.outblock" >> $GITHUB_STEP_SUMMARY
        echo "- **Artifact ID**: web3-provider" >> $GITHUB_STEP_SUMMARY
        echo "- **Version**: ${{ steps.version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“‹ Usage" >> $GITHUB_STEP_SUMMARY
        echo '```gradle' >> $GITHUB_STEP_SUMMARY
        echo 'dependencies {' >> $GITHUB_STEP_SUMMARY
        echo '    implementation "io.outblock:web3-provider:${{ steps.version.outputs.version }}"' >> $GITHUB_STEP_SUMMARY
        echo '}' >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Repository Setup" >> $GITHUB_STEP_SUMMARY
        echo '```gradle' >> $GITHUB_STEP_SUMMARY
        echo 'repositories {' >> $GITHUB_STEP_SUMMARY
        echo '    maven {' >> $GITHUB_STEP_SUMMARY
        echo '        url = uri("https://maven.pkg.github.com/Outblock/trust-web3-provider")' >> $GITHUB_STEP_SUMMARY
        echo '        credentials {' >> $GITHUB_STEP_SUMMARY
        echo '            username = project.findProperty("gpr.user") ?: System.getenv("GPR_USER")' >> $GITHUB_STEP_SUMMARY
        echo '            password = project.findProperty("gpr.key") ?: System.getenv("GPR_API_KEY")' >> $GITHUB_STEP_SUMMARY
        echo '        }' >> $GITHUB_STEP_SUMMARY
        echo '    }' >> $GITHUB_STEP_SUMMARY
        echo '}' >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY